name: Release Linux Binaries

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    name: Build & Release (${{ matrix.arch }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Install project
        run: |
          pip install -e .

      - name: Build binaries (PyInstaller)
        run: |
          set -e
          rm -rf dist build *.spec
          mkdir -p dist/bin
      
          pyinstaller -F -n observix -m observix_cli
          mv dist/observix dist/bin/observix
      
          pyinstaller -F -n observix-agent -m observix_agent
          mv dist/observix-agent dist/bin/observix-agent
      
          pyinstaller -F -n observix-control-plane -m observix_control_plane
          mv dist/observix-control-plane dist/bin/observix-control-plane
      
          pyinstaller -F -n observix-indexer -m observix_indexer
          mv dist/observix-indexer dist/bin/observix-indexer
      
          chmod +x dist/bin/*

      - name: Assemble release bundle
        run: |
          set -euo pipefail

          BUNDLE="observix-linux-${{ matrix.arch }}"
          rm -rf "${BUNDLE}"
          mkdir -p "${BUNDLE}/bin" "${BUNDLE}/systemd" "${BUNDLE}/config" "${BUNDLE}/config/pipelines"

          # Binaries
          cp -a dist/bin/* "${BUNDLE}/bin/"

          # Systemd
          cp -a packaging/systemd/* "${BUNDLE}/systemd/"

          pick_file () {
            local out_var="$1"; shift
            local found=""
            for cand in "$@"; do
              if [[ -f "$cand" ]]; then
                found="$cand"
                break
              fi
            done

            if [[ -z "$found" ]]; then
              echo "ERROR: none of these files exist:" >&2
              printf '  - %s\n' "$@" >&2
              echo "" >&2
              echo "DEBUG: repo tree under packaging/config:" >&2
              ls -la packaging/config || true
              echo "" >&2
              find packaging -maxdepth 4 -type f | sed 's/^/  - /' >&2 || true
              exit 1
            fi

            printf -v "$out_var" '%s' "$found"
          }

          # Configs (support both hyphen and underscore filenames)
          CP_CFG=""
          IDX_CFG=""
          AGENT_CFG=""

          pick_file CP_CFG \
            packaging/config/control-plane.yaml \
            packaging/config/control_plane.yaml \
            packaging/config/control-plane.yml \
            packaging/config/control_plane.yml

          pick_file IDX_CFG \
            packaging/config/indexer.yaml \
            packaging/config/indexer.yml

          pick_file AGENT_CFG \
            packaging/config/agent.example.yaml \
            packaging/config/agent.example.yml

          cp -a "$CP_CFG" "${BUNDLE}/config/control-plane.yaml"
          cp -a "$IDX_CFG" "${BUNDLE}/config/indexer.yaml"
          cp -a "$AGENT_CFG" "${BUNDLE}/config/agent.example.yaml"

          # Pipelines
          if [[ -d packaging/config/pipelines ]]; then
            cp -a packaging/config/pipelines/* "${BUNDLE}/config/pipelines/" || true
          fi

          # Tools + docs
          cp -a packaging/install.sh "${BUNDLE}/install.sh"
          cp -a packaging/uninstall.sh "${BUNDLE}/uninstall.sh"
          cp -a packaging/observix-ctl "${BUNDLE}/observix-ctl"
          cp -a packaging/README.md "${BUNDLE}/README.md"

          chmod +x "${BUNDLE}/install.sh" "${BUNDLE}/uninstall.sh" "${BUNDLE}/observix-ctl"
          tar -czf "${BUNDLE}.tar.gz" "${BUNDLE}"


      - name: Create checksums
        run: |
          sha256sum "observix-linux-${{ matrix.arch }}.tar.gz" > "sha256sums-${{ matrix.arch }}.txt"
          sha256sum dist/bin/observix >> "sha256sums-${{ matrix.arch }}.txt"
          sha256sum dist/bin/observix-agent >> "sha256sums-${{ matrix.arch }}.txt"
          sha256sum dist/bin/observix-control-plane >> "sha256sums-${{ matrix.arch }}.txt"
          sha256sum dist/bin/observix-indexer >> "sha256sums-${{ matrix.arch }}.txt"

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/bin/observix
            dist/bin/observix-agent
            dist/bin/observix-control-plane
            dist/bin/observix-indexer
            observix-linux-${{ matrix.arch }}.tar.gz
            sha256sums-${{ matrix.arch }}.txt
