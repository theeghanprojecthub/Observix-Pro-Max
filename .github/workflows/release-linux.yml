name: Release Linux Binaries

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    name: Build & Release (${{ matrix.arch }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Install project
        run: |
          pip install -e .

      - name: Build binaries (PyInstaller)
        run: |
          set -e
          rm -rf dist build *.spec
          mkdir -p dist/bin

          # CLI
          pyinstaller -F -n observix src/observix_cli/__main__.py
          mv dist/observix dist/bin/observix

          # Agent
          pyinstaller -F -n observix-agent src/observix_agent/__main__.py
          mv dist/observix-agent dist/bin/observix-agent

          # Control plane (your package has __main__.py)
          pyinstaller -F -n observix-control-plane src/observix_control_plane/__main__.py
          mv dist/observix-control-plane dist/bin/observix-control-plane

          # Indexer (your package has __main__.py)
          pyinstaller -F -n observix-indexer src/observix_indexer/__main__.py
          mv dist/observix-indexer dist/bin/observix-indexer

          chmod +x dist/bin/*

      - name: Assemble release bundle
        run: |
          set -e
          BUNDLE="observix-linux-${{ matrix.arch }}"
          rm -rf "${BUNDLE}"
          mkdir -p "${BUNDLE}/bin" "${BUNDLE}/systemd" "${BUNDLE}/config" "${BUNDLE}/config/pipelines"

          # Binaries
          cp -a dist/bin/* "${BUNDLE}/bin/"

          # Packaging assets (match your repo structure)
          cp -a packaging/systemd/* "${BUNDLE}/systemd/"
          cp -a packaging/config/control-plane.yaml "${BUNDLE}/config/"
          cp -a packaging/config/indexer.yaml "${BUNDLE}/config/"
          cp -a packaging/config/agent.example.yaml "${BUNDLE}/config/"
          cp -a packaging/config/pipelines/* "${BUNDLE}/config/pipelines/"

          cp -a packaging/install.sh "${BUNDLE}/install.sh"
          cp -a packaging/uninstall.sh "${BUNDLE}/uninstall.sh"
          cp -a packaging/observix-ctl "${BUNDLE}/observix-ctl"
          cp -a packaging/README.md "${BUNDLE}/README.md"

          chmod +x "${BUNDLE}/install.sh" "${BUNDLE}/uninstall.sh" "${BUNDLE}/observix-ctl"
          tar -czf "${BUNDLE}.tar.gz" "${BUNDLE}"

      - name: Create checksums
        run: |
          sha256sum "observix-linux-${{ matrix.arch }}.tar.gz" > "sha256sums-${{ matrix.arch }}.txt"
          sha256sum dist/bin/observix >> "sha256sums-${{ matrix.arch }}.txt"
          sha256sum dist/bin/observix-agent >> "sha256sums-${{ matrix.arch }}.txt"
          sha256sum dist/bin/observix-control-plane >> "sha256sums-${{ matrix.arch }}.txt"
          sha256sum dist/bin/observix-indexer >> "sha256sums-${{ matrix.arch }}.txt"

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/bin/observix
            dist/bin/observix-agent
            dist/bin/observix-control-plane
            dist/bin/observix-indexer
            observix-linux-${{ matrix.arch }}.tar.gz
            sha256sums-${{ matrix.arch }}.txt
