name: Release Linux Binaries

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
            py: "3.11"
          - os: ubuntu-latest
            arch: arm64
            py: "3.11"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Install project
        run: |
          pip install -e .

      - name: Build binaries (PyInstaller)
        run: |
          set -e
          mkdir -p dist/bin

          # CLI (module package has __main__.py)
          pyinstaller -F -n observix -m observix_cli
          mv dist/observix dist/bin/observix

          # Agent (module package has __main__.py)
          pyinstaller -F -n observix-agent -m observix_agent
          mv dist/observix-agent dist/bin/observix-agent

          # Control plane (target a module that actually exists)
          pyinstaller -F -n observix-control-plane -m observix_control_plane.cli
          mv dist/observix-control-plane dist/bin/observix-control-plane

          # Indexer (target a module that actually exists)
          pyinstaller -F -n observix-indexer -m observix_indexer.cli
          mv dist/observix-indexer dist/bin/observix-indexer

      - name: Assemble release bundle
        run: |
          set -e
          BUNDLE="observix-linux-${{ matrix.arch }}"
          rm -rf "${BUNDLE}"
          mkdir -p "${BUNDLE}/bin" "${BUNDLE}/systemd" "${BUNDLE}/config" "${BUNDLE}/config/pipelines"

          # Binaries
          cp -a dist/bin/* "${BUNDLE}/bin/"

          # Packaging assets (match your repo structure)
          cp -a packaging/systemd/* "${BUNDLE}/systemd/"
          cp -a packaging/config/control-plane.yaml "${BUNDLE}/config/"
          cp -a packaging/config/indexer.yaml "${BUNDLE}/config/"
          cp -a packaging/config/agent.example.yaml "${BUNDLE}/config/"
          cp -a packaging/config/pipelines/* "${BUNDLE}/config/pipelines/"

          cp -a packaging/install.sh "${BUNDLE}/install.sh"
          cp -a packaging/uninstall.sh "${BUNDLE}/uninstall.sh"
          cp -a packaging/observix-ctl "${BUNDLE}/observix-ctl"
          cp -a packaging/README.md "${BUNDLE}/README.md"

          chmod +x "${BUNDLE}/install.sh" "${BUNDLE}/uninstall.sh" "${BUNDLE}/observix-ctl"
          tar -czf "${BUNDLE}.tar.gz" "${BUNDLE}"

      - name: Create checksums
        run: |
          sha256sum "observix-linux-${{ matrix.arch }}.tar.gz" >> sha256sums.txt

      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            observix-linux-${{ matrix.arch }}.tar.gz
            sha256sums.txt
